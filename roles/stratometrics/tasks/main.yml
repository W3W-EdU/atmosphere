# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Get an existing Secret for Nova
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: nova-rabbitmq-user
    namespace: openstack
  register: stratometrics_nova_secrets
  failed_when: stratometrics_nova_secrets.resources | length == 0

- name: Deploy Stratometrics
  run_once: true
  kubernetes.core.k8s:
    state: present
    definition:
      - apiVerison: v1
        kind: Secret
        metadata:
          name: config
          namespace: stratometrics
          labels:
            app.kubernetes.io/name: stratometrics
        stringData:
          GIN_MODE: release
          CLICKHOUSE_HOST: clickhouse:9000
          CLICKHOUSE_USERNAME: stratometrics
          CLICKHOUSE_PASSWORD: "{{ stratometrics_database_password }}"
          NOVA_TRANSPORT_URL: "{{ stratometrics_nova_secrets.resources[0].data.RABBITMQ_CONNECTION | b64decode | regex_replace('rabbit://', 'amqp://') | regex_replace('15672', '5672') }}"
          OS_AUTH_URL: "{{ openstack_helm_endpoints['identity']['scheme']['public'] }}://{{ openstack_helm_endpoints['identity']['host_fqdn_override']['public']['host'] }}/v3"
          OS_DOMAIN_NAME: Default
          OS_USERNAME: "{{ openstack_helm_endpoints['identity']['auth']['admin']['username'] }}"
          OS_PASSWORD: "{{ openstack_helm_endpoints['identity']['auth']['admin']['password'] }}"
          OS_PROJECT_NAME: admin

      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: listener
          namespace: stratometrics
        spec:
          replicas: 1
          selector:
            matchLabels:
              app.kubernetes.io/name: stratometrics
              app.kubernetes.io/component: listener
          template:
            metadata:
              labels:
                app.kubernetes.io/name: stratometrics
                app.kubernetes.io/component: listener
            spec:
              containers:
                - name: listener
                  image: "{{ atmosphere_images['stratometrics_listener'] | vexxhost.kubernetes.docker_image('ref') }}"
                  envFrom:
                    - secretRef:
                        name: config
              nodeSelector:
                openstack-control-plane: enabled

      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: api
          namespace: stratometrics
        spec:
          replicas: 2
          selector:
            matchLabels:
              app.kubernetes.io/name: stratometrics
              app.kubernetes.io/component: api
          template:
            metadata:
              labels:
                app.kubernetes.io/name: stratometrics
                app.kubernetes.io/component: api
            spec:
              containers:
                - name: api
                  image: "{{ atmosphere_images['stratometrics_api'] | vexxhost.kubernetes.docker_image('ref') }}"
                  envFrom:
                    - secretRef:
                        name: config
              nodeSelector:
                openstack-control-plane: enabled

      - apiVersion: v1
        kind: Service
        metadata:
          name: api
          namespace: stratometrics
          labels:
            app.kubernetes.io/name: stratometrics
            app.kubernetes.io/component: api
        spec:
          type: ClusterIP
          ports:
          - name: api
            port: 8080
            protocol: TCP
            targetPort: 8080
          selector:
            app.kubernetes.io/name: stratometrics
            app.kubernetes.io/component: api

- name: Create Ingress
  ansible.builtin.include_role:
    name: ingress
  vars:
    ingress_name: api
    ingress_namespace: stratometrics
    ingress_class_name: "{{ stratometrics_ingress_class_name }}"
    ingress_host: "{{ stratometrics_host }}"
    ingress_service_name: api
    ingress_service_port: 8080
    ingress_secret_name: "{{ stratometrics_ingress_tls_secret_name }}"
    ingress_annotations: "{{ stratometrics_ingress_annotations }}"
